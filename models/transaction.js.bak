const db = require('../db');

const Transaction = {
  create: async (data) => {
    const sql = `INSERT INTO transactions (orderId, captureId, payerId, payerEmail, amount, currency, status, time)
                 VALUES (?, ?, ?, ?, ?, ?, ?, ?)`;
    const params = [data.orderId, data.captureId || null, data.payerId, data.payerEmail, data.amount, data.currency, data.status, data.time];
    const [result] = await db.query(sql, params);
    return result;
  },

  getByOrderId: async (orderId) => {
    const sql = `SELECT orderId, captureId, payerId, payerEmail, amount, currency, status, time
                 FROM transactions
                 WHERE orderId = ?
                 ORDER BY id DESC
                 LIMIT 1`;
    const [rows] = await db.query(sql, [orderId]);
    return rows && rows.length ? rows[0] : null;
  },

  getAllLatestByOrderIds: async (orderIds) => {
    if (!orderIds || !orderIds.length) return [];
    const sql = `
      SELECT t1.* FROM transactions t1
      INNER JOIN (
        SELECT orderId, MAX(id) as maxId
        FROM transactions
        WHERE orderId IN (${orderIds.map(() => '?').join(',')})
        GROUP BY orderId
      ) t2 ON t1.orderId = t2.orderId AND t1.id = t2.maxId
    `;
    const [rows] = await db.query(sql, orderIds);
    return rows || [];
  }
};

module.exports = Transaction;
