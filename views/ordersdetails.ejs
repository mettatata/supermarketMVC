<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Order Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    @media print {
      .no-print { display: none !important; }
      body { -webkit-print-color-adjust: exact; }
    }
    .order-header { margin-top: 20px; margin-bottom: 20px; }
    table th, table td { vertical-align: middle !important; }
  </style>
</head>
<body>
  <%- include('partials/navbar') %>
  <%- include('partials/flash') %>
  <style>
    @media print {
      .no-print { display: none !important; }
      /* hide the main navigation when printing this page */
      nav.navbar { display: none !important; }
    }
  </style>
  <main class="container my-5">
    <h2>Your Orders Details </h2>
    <p>Orders for <strong><%= user ? (user.username || user.name || user.email) : 'User' %></strong></p>
    <% if (typeof orderDetails !== 'undefined' && orderDetails && orderDetails.length) { %>
      <h4>Order ID: <%= order ? (order.orderid || order.id) : '' %></h4>
      <p>Placed: <%= order && order.created_at ? new Date(order.created_at).toLocaleString() : '' %></p>
        <div class="mb-3">
          <strong>Shipping Address:</strong><br>
          <%= order && order.address ? order.address : 'No address provided' %>
        </div>

        <% if (paymentMethod) { %>
        <div class="mb-3">
          <strong>Payment Method:</strong> <%= paymentMethod %>
        </div>
        <% } %>
        <% if (transaction && transaction.captureId) { %>
        <div class="mb-3">
          <strong>Payment Reference:</strong> <%= transaction.captureId %>
        </div>
        <% } %>

      <table class="table table-striped">
        <thead>
          <tr>
            <th>Product</th>
            <th class="text-center">Quantity</th>
            <th class="text-end">Unit Price</th>
            <th class="text-end">Total</th>
          </tr>
        </thead>
        <tbody>
          <% let grand = 0; %>
          <% orderDetails.forEach(function(it) { %>
            <% const pname = it.productname || it.product_name || ('Product ' + (it.productid || '')); %>
            <% const qty = Number(it.quantity || 0);
               const unit = Number(it.unitprice || it.price || 0);
               const line = (typeof it.lineTotal !== 'undefined' && it.lineTotal !== null) ? Number(it.lineTotal) : (Number(it.total) || (unit * qty));
               grand += line; %>
            <tr>
              <td><%= pname %></td>
              <td class="text-center"><%= qty %></td>
              <td class="text-end">$<%= unit.toFixed(2) %></td>
              <td class="text-end">$<%= line.toFixed(2) %></td>
            </tr>
          <% }) %>
        </tbody>
        <tfoot>
          <tr>
            <th colspan="3" class="text-end">Grand Total</th>
            <th class="text-end">$<%= (typeof grandTotal !== 'undefined' ? Number(grandTotal).toFixed(2) : grand.toFixed(2)) %></th>
          </tr>
        </tfoot>
      </table>
      <a href="/orders" class="btn btn-secondary no-print">Back to Orders</a>
      <button onclick="window.print()" class="btn btn-info no-print">Print</button>
    <% } else { %>
      <% if (!orders || !orders.length) { %>
        <div class="alert alert-info">You have no orders yet.</div>
      <% } else { %>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Total</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% orders.forEach(function(order) { %>
              <tr>
                <td><%= order.orderid %></td>
                <td>$<%= (Number(order.total) || 0).toFixed(2) %></td>
                <td><%= order.created_at ? new Date(order.created_at).toLocaleString() : '' %></td>
                <td>
                  <a href="/orderdetails?orderId=<%= order.orderid %>" class="btn btn-sm btn-primary">Details</a>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    <% } %>

  </main>
</body>
</html>